name: ledger-validate
on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 16 * * 0" # So 16:00 UTC (So 18:00 lokal ~ Beispiel)
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Run Ledger Validation (pilot, tolerate warnings)
        continue-on-error: true
        env:
          MAX_DRIFT_WARN: "5"
          MIN_HEALTH_WARN: "90"
          HARMONY_EXPECTED_GREEN: "false"
        run: node scripts/validate_ledger.mjs --max-drift=5 --min-health=80

      - name: Classify outcome (set job conclusion)
        if: always()
        run: |
          echo "status: postprocess | reading artefacts/logs/validator_exit.json"
          code=$(jq -r '.exit // "0"' artefacts/logs/validator_exit.json 2>/dev/null || echo "0")
          echo "validator_exit=$code"
          if [ "$code" = "1" ]; then
            echo "::error::Ledger validation failed (exit=1)."
            exit 1
          elif [ "$code" = "2" ]; then
            echo "::warning::Ledger validation reported warnings (exit=2)."
            exit 0
          else
            echo "Ledger validation passed."
            exit 0
          fi
